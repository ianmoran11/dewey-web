async function W(o,t){let a;if(o instanceof Blob?a=o.stream():a=o,a instanceof ReadableStream&&t){const e=a.getReader();switch(t){case"callback":return async()=>(await e.read()).value;case"buffer":const i=[];let r=!1;for(;!r;){const h=await e.read();h.value&&i.push(h.value),r=h.done}const s=i.reduce((h,d)=>h+d.length,0),c=new Uint8Array(s);let l=0;return i.forEach(h=>{c.set(h,l),l+=h.length}),c.buffer}}else return a}function F(o){const t=o.split(/[\\/]/).filter(i=>i!==""),a=t.pop();if(!a)throw new Error("Database path is invalid.");const n=["journal","wal","shm"].map(i=>`${a}-${i}`);return{directories:t,fileName:a,tempFileNames:n,getDirectoryHandle:async()=>{let i=await navigator.storage.getDirectory();for(let r of t)i=await i.getDirectoryHandle(r);return i}}}class ${constructor(t){Object.defineProperty(this,"sqlite3InitModule",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"sqlite3",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"db",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pointers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"writeCallbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"storageType",{enumerable:!0,configurable:!0,writable:!0,value:"memory"})}async init(t){const{databasePath:a}=t,n=this.getFlags(t);if(!this.sqlite3InitModule){const{default:e}=await import("./index-BBSPvAFz.js");this.sqlite3InitModule=e}this.sqlite3||(this.sqlite3=await this.sqlite3InitModule()),this.db&&await this.destroy(),this.db=new this.sqlite3.oo1.DB(a,n),this.config=t,this.initWriteHook()}onWrite(t){return this.writeCallbacks.add(t),()=>{this.writeCallbacks.delete(t)}}async exec(t){if(!this.db)throw new Error("Driver not initialized");return this.execOnDb(this.db,t)}async execBatch(t){if(!this.db)throw new Error("Driver not initialized");const a=[];return this.db.transaction(n=>{var i;const e=new Map;try{for(let r of t){let s=e.get(r.sql);if(!s){const h=n.prepare(r.sql);e.set(r.sql,h),s=h}(i=r.params)!=null&&i.length&&s.bind(r.params);let c=[],l=[];for(;s.step();)c=s.getColumnNames([]),l.push(s.get([]));a.push({columns:c,rows:l}),s.reset()}}finally{e.forEach(r=>{r.finalize()})}}),a}async isDatabasePersisted(){return!1}async getDatabaseSizeBytes(){var n;const t=await this.exec({sql:`SELECT page_count * page_size AS size 
				FROM pragma_page_count(), pragma_page_size()`,method:"get"}),a=(n=t==null?void 0:t.rows)==null?void 0:n[0];if(typeof a!="number")throw new Error("Failed to query database size");return a}async createFunction(t){if(!this.db)throw new Error("Driver not initialized");switch(t.type){case"callback":case"scalar":this.db.createFunction({name:t.name,xFunc:(a,...n)=>t.func(...n),arity:-1});break;case"aggregate":this.db.createFunction({name:t.name,xStep:(a,...n)=>t.func.step(...n),xFinal:(a,...n)=>t.func.final(...n),arity:-1});break}}async import(t){if(!this.sqlite3||!this.db||!this.config)throw new Error("Driver not initialized");const a=await W(t,"buffer"),n=this.sqlite3.wasm.allocFromTypedArray(a);this.pointers.push(n);const e=this.sqlite3.capi.sqlite3_deserialize(this.db,"main",n,a.byteLength,a.byteLength,this.config.readOnly?this.sqlite3.capi.SQLITE_DESERIALIZE_READONLY:this.sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE);this.db.checkRc(e)}async export(){if(!this.sqlite3||!this.db)throw new Error("Driver not initialized");return{name:"database.sqlite3",data:this.sqlite3.capi.sqlite3_js_db_export(this.db)}}async clear(){}async destroy(){this.closeDb(),this.pointers.forEach(t=>{var a;return(a=this.sqlite3)==null?void 0:a.wasm.dealloc(t)}),this.pointers=[],this.writeCallbacks.clear()}getFlags(t){const{readOnly:a,verbose:n}=t;return[a===!0?"r":"cw",n===!0?"t":""].join("")}execOnDb(t,a){const n={rows:[],columns:[]},e=t.exec({sql:a.sql,bind:a.params,returnValue:"resultRows",rowMode:"array",columnNames:n.columns});switch(a.method){case"run":break;case"get":n.rows=e[0]??[];break;case"all":default:n.rows=e;break}return n}initWriteHook(){var a;if(!((a=this.config)!=null&&a.reactive))return;if(!this.sqlite3||!this.db)throw new Error("Driver not initialized");const t={[this.sqlite3.capi.SQLITE_INSERT]:"insert",[this.sqlite3.capi.SQLITE_UPDATE]:"update",[this.sqlite3.capi.SQLITE_DELETE]:"delete"};this.sqlite3.capi.sqlite3_update_hook(this.db,(n,e,i,r,s)=>{this.writeCallbacks.forEach(c=>{c({table:r,rowid:s,operation:t[e]})})},0)}closeDb(){this.db&&(this.db.close(),this.db=void 0)}}class G extends ${constructor(t){super(t),Object.defineProperty(this,"storageType",{enumerable:!0,configurable:!0,writable:!0,value:"opfs"})}async init(t){const{databasePath:a}=t,n=this.getFlags(t);if(!a)throw new Error("No databasePath specified");if(!this.sqlite3InitModule){const{default:e}=await import("./index-BBSPvAFz.js");this.sqlite3InitModule=e}if(this.sqlite3||(this.sqlite3=await this.sqlite3InitModule()),!("opfs"in this.sqlite3))throw new Error("OPFS not available");this.db&&await this.destroy(),this.db=new this.sqlite3.oo1.OpfsDb(a,n),this.config=t,this.initWriteHook()}async isDatabasePersisted(){var t;return(t=navigator.storage)==null?void 0:t.persisted()}async import(t){var n;if(!this.sqlite3||!((n=this.config)!=null&&n.databasePath))throw new Error("Driver not initialized");await this.destroy();const a=await W(t,"callback");await this.sqlite3.oo1.OpfsDb.importDb(this.config.databasePath,a)}async export(){var d;if(!this.db||!((d=this.config)!=null&&d.databasePath))throw new Error("Driver not initialized");let t,a;const n=F(this.config.databasePath),{directories:e,getDirectoryHandle:i}=n;t=n.fileName;const r=`backup-${Date.now()}--${t}`,s=`${e.join("/")}/${r}`;this.db.exec({sql:"VACUUM INTO ?",bind:[s]});const c=await i();return a=await(await(await c.getFileHandle(r)).getFile()).arrayBuffer(),await c.removeEntry(r),{name:t,data:a}}async clear(){var r;if(!((r=this.config)!=null&&r.databasePath))throw new Error("Driver not initialized");await this.destroy();const{getDirectoryHandle:t,fileName:a,tempFileNames:n}=F(this.config.databasePath),e=await t(),i=[a,...n];await Promise.all(i.map(async s=>e.removeEntry(s).catch(c=>{if(!(c instanceof DOMException&&c.name==="NotFoundError"))throw c})))}async destroy(){this.closeDb(),this.writeCallbacks.clear()}}const A="function",D="64e10b34-2bf7-4616-9668-f99de5aa046e",Y="get",J="has",Z="set",{isArray:_}=Array;let{SharedArrayBuffer:O,window:V}=globalThis,{notify:B,wait:H,waitAsync:T}=Atomics,U=null;T||(T=o=>({value:new Promise(t=>{let a=new Worker("data:application/javascript,onmessage%3D(%7Bdata%3Ab%7D)%3D%3E(Atomics.wait(b%2C0)%2CpostMessage(0))");a.onmessage=t,a.postMessage(o)})}));try{new O(4)}catch{O=ArrayBuffer;const t=new WeakMap;if(V){const a=new Map,{prototype:{postMessage:n}}=Worker,e=i=>{var s;const r=(s=i.data)==null?void 0:s[D];if(!_(r)){i.stopImmediatePropagation();const{id:c,sb:l}=r;a.get(c)(l)}};U=function(i,...r){const s=i==null?void 0:i[D];if(_(s)){const[c,l]=s;t.set(l,c),this.addEventListener("message",e)}return n.call(this,i,...r)},T=i=>({value:new Promise(r=>{a.set(t.get(i),r)}).then(r=>{a.delete(t.get(i)),t.delete(i);for(let s=0;s<r.length;s++)i[s]=r[s];return"ok"})})}else{const a=(n,e)=>({[D]:{id:n,sb:e}});B=n=>{postMessage(a(t.get(n),n))},addEventListener("message",n=>{var i;const e=(i=n.data)==null?void 0:i[D];if(_(e)){const[r,s]=e;t.set(s,r)}})}}/*! (c) Andrea Giammarchi - ISC */const{Int32Array:I,Map:L,Uint16Array:j}=globalThis,{BYTES_PER_ELEMENT:N}=I,{BYTES_PER_ELEMENT:X}=j,ee=(o,t,a)=>{for(;H(o,0,0,t)==="timed-out";)a()},C=new WeakSet,S=new WeakMap,te={value:{then:o=>o()}};let ie=0;const R=(o,{parse:t=JSON.parse,stringify:a=JSON.stringify,transform:n,interrupt:e}=JSON)=>{if(!S.has(o)){const i=U||o.postMessage,r=(b,...f)=>i.call(o,{[D]:f},{transfer:b}),s=typeof e===A?e:e==null?void 0:e.handler,c=(e==null?void 0:e.delay)||42,l=new TextDecoder("utf-16"),h=(b,f)=>b?T(f,0):(s?ee(f,c,s):H(f,0),te);let d=!1;S.set(o,new Proxy(new L,{[J]:(b,f)=>typeof f=="string"&&!f.startsWith("_"),[Y]:(b,f)=>f==="then"?null:(...k)=>{const q=ie++;let y=new I(new O(N*2)),g=[];C.has(k.at(-1)||g)&&C.delete(g=k.pop()),r(g,q,y,f,n?k.map(n):k);const E=o!==globalThis;let P=0;return d&&E&&(P=setTimeout(console.warn,1e3,`ðŸ’€ðŸ”’ - Possible deadlock if proxy.${f}(...args) is awaited`)),h(E,y).value.then(()=>{clearTimeout(P);const M=y[1];if(!M)return;const m=X*M;return y=new I(new O(m+m%N)),r([],q,y),h(E,y).value.then(()=>t(l.decode(new j(y.buffer).slice(0,M))))})},[Z](b,f,k){const q=typeof k;if(q!==A)throw new Error(`Unable to assign ${f} as ${q}`);if(!b.size){const y=new L;o.addEventListener("message",async g=>{var P;const E=(P=g.data)==null?void 0:P[D];if(_(E)){g.stopImmediatePropagation();const[M,m,...u]=E;let p;if(u.length){const[w,x]=u;if(b.has(w)){d=!0;try{const v=await b.get(w)(...x);if(v!==void 0){const K=a(n?n(v):v);y.set(M,K),m[1]=K.length}}catch(v){p=v}finally{d=!1}}else p=new Error(`Unsupported action: ${w}`);m[0]=1}else{const w=y.get(M);y.delete(M);for(let x=new j(m.buffer),v=0;v<w.length;v++)x[v]=w.charCodeAt(v)}if(B(m,0),p)throw p}})}return!!b.set(f,k)}}))}return S.get(o)};R.transfer=(...o)=>(C.add(o),o);function z(){let o,t;return{lock:async()=>{for(;o;)await o;o=new Promise(e=>{t=e})},unlock:async()=>{const e=t;o=void 0,t=void 0,e==null||e()}}}function re(o,t,a){let n,e,i,r,s,c,l=0,h=!1,d=!1,b=!0;if(typeof o!="function")throw new TypeError("Expected a function");t=Number(t)||0,typeof a=="object"&&a!==null&&(h=!!a.leading,d="maxWait"in a,i=d?Math.max(Number(a.maxWait)||0,t):0,b="trailing"in a?!!a.trailing:b);function f(u){const p=n,w=e;return n=e=void 0,l=u,r=o.apply(w,p),r}function k(u){return l=u,s=setTimeout(g,t),h?f(u):r}function q(u){const p=u-(c??0),w=u-l,x=t-p;return d?Math.min(x,i-w):x}function y(u){const p=u-(c??0),w=u-l;return c===void 0||p>=t||p<0||d&&w>=i}function g(){const u=Date.now();if(y(u))return E(u);s=setTimeout(g,q(u))}function E(u){return s=void 0,b&&n?f(u):(n=e=void 0,r)}function P(){s!==void 0&&clearTimeout(s),l=0,n=c=e=s=void 0}function M(){return s===void 0?r:E(Date.now())}function m(){const u=Date.now(),p=y(u);if(n=arguments,e=this,c=u,p){if(s===void 0)return k(c);if(d)return s=setTimeout(g,t),f(c)}return s===void 0&&(s=setTimeout(g,t)),r}return m.cancel=P,m.flush=M,m}function ae(){return crypto.randomUUID()}function se(o,t){switch(o){case"session":case":sessionStorage:":let a=sessionStorage._sqlocal_session_key;return a||(a=ae(),sessionStorage._sqlocal_session_key=a),`session:${a}`;case"local":case":localStorage:":return"local";case":memory:":return`memory:${t}`;default:return`path:${o}`}}class ne{constructor(t){Object.defineProperty(this,"driver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"userFunctions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"initMutex",{enumerable:!0,configurable:!0,writable:!0,value:z()}),Object.defineProperty(this,"transactionMutex",{enumerable:!0,configurable:!0,writable:!0,value:z()}),Object.defineProperty(this,"transactionKey",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"proxy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dirtyTables",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"effectsChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reinitChannel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onmessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"init",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{if(!(!this.config.databasePath||!this.config.clientKey)){await this.initMutex.lock();try{try{await this.driver.init(this.config)}catch{console.warn(`Persistence failed, so ${this.config.databasePath} will not be saved. For origin private file system persistence, make sure your web server is configured to use the correct HTTP response headers (See https://sqlocal.dev/guide/setup#cross-origin-isolation).`),this.config.databasePath=":memory:",this.driver=new $,await this.driver.init(this.config)}const i=se(this.config.databasePath,this.config.clientKey);this.reinitChannel=new BroadcastChannel(`_sqlocal_reinit_(${i})`),this.reinitChannel.onmessage=r=>{const s=r.data;if(this.config.clientKey!==s.clientKey)switch(s.type){case"reinit":this.init(s.reason);break;case"close":this.driver.destroy();break}},this.config.reactive&&(this.effectsChannel=new BroadcastChannel(`_sqlocal_effects_(${i})`),this.driver.onWrite(async r=>{this.dirtyTables.add(r.table),await this.transactionMutex.lock(),this.emitEffectsDebounced(),await this.transactionMutex.unlock()})),await Promise.all(Array.from(this.userFunctions.values()).map(r=>this.initUserFunction(r))),await this.execInitStatements(),this.emitMessage({type:"event",event:"connect",reason:e})}catch(i){this.emitMessage({type:"error",error:i,queryKey:null}),await this.destroy()}finally{await this.initMutex.unlock()}}}}),Object.defineProperty(this,"postMessage",{enumerable:!0,configurable:!0,writable:!0,value:async(e,i)=>{const r=e instanceof MessageEvent?e.data:e;switch(await this.initMutex.lock(),r.type){case"config":this.editConfig(r);break;case"query":case"batch":case"transaction":this.exec(r);break;case"function":this.createUserFunction(r);break;case"getinfo":this.getDatabaseInfo(r);break;case"import":this.importDb(r);break;case"export":this.exportDb(r);break;case"delete":this.deleteDb(r);break;case"destroy":this.destroy(r);break}await this.initMutex.unlock()}}),Object.defineProperty(this,"emitMessage",{enumerable:!0,configurable:!0,writable:!0,value:(e,i=[])=>{this.onmessage&&this.onmessage(e,i)}}),Object.defineProperty(this,"emitEffects",{enumerable:!0,configurable:!0,writable:!0,value:()=>{!this.effectsChannel||this.dirtyTables.size===0||(this.effectsChannel.postMessage({type:"effects",tables:[...this.dirtyTables]}),this.dirtyTables.clear())}}),Object.defineProperty(this,"emitEffectsDebounced",{enumerable:!0,configurable:!0,writable:!0,value:re(()=>this.emitEffects(),32,{maxWait:180})}),Object.defineProperty(this,"editConfig",{enumerable:!0,configurable:!0,writable:!0,value:e=>{this.config=e.config,this.init("initial")}}),Object.defineProperty(this,"exec",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{try{const i={type:"data",queryKey:e.queryKey,data:[]};switch(e.type){case"query":const r=this.transactionKey!==null&&this.transactionKey===e.transactionKey;try{r||await this.transactionMutex.lock();const s=await this.driver.exec(e);i.data.push(s)}finally{r||await this.transactionMutex.unlock()}break;case"batch":try{await this.transactionMutex.lock();const s=await this.driver.execBatch(e.statements);i.data.push(...s)}finally{await this.transactionMutex.unlock()}break;case"transaction":if(e.action==="begin"&&(await this.transactionMutex.lock(),this.transactionKey=e.transactionKey,await this.driver.exec({sql:"BEGIN"})),(e.action==="commit"||e.action==="rollback")&&this.transactionKey!==null&&this.transactionKey===e.transactionKey){const s=e.action==="commit"?"COMMIT":"ROLLBACK";await this.driver.exec({sql:s}),this.transactionKey=null,await this.transactionMutex.unlock()}break}this.emitMessage(i)}catch(i){this.emitMessage({type:"error",error:i,queryKey:e.queryKey})}}}),Object.defineProperty(this,"execInitStatements",{enumerable:!0,configurable:!0,writable:!0,value:async()=>{if(this.config.onInitStatements)for(let e of this.config.onInitStatements)await this.driver.exec(e)}}),Object.defineProperty(this,"getDatabaseInfo",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{try{this.emitMessage({type:"info",queryKey:e.queryKey,info:{databasePath:this.config.databasePath,storageType:this.driver.storageType,databaseSizeBytes:await this.driver.getDatabaseSizeBytes(),persisted:await this.driver.isDatabasePersisted()}})}catch(i){this.emitMessage({type:"error",queryKey:e.queryKey,error:i})}}}),Object.defineProperty(this,"createUserFunction",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{const{functionName:i,functionType:r,queryKey:s}=e;let c;if(this.userFunctions.has(i)){this.emitMessage({type:"error",error:new Error(`A user-defined function with the name "${i}" has already been created for this SQLocal instance.`),queryKey:s});return}switch(r){case"callback":c={type:r,name:i,func:(...l)=>{this.emitMessage({type:"callback",name:i,args:l})}};break;case"scalar":c={type:r,name:i,func:this.proxy[`_sqlocal_func_${i}`]};break;case"aggregate":c={type:r,name:i,func:{step:this.proxy[`_sqlocal_func_${i}_step`],final:this.proxy[`_sqlocal_func_${i}_final`]}};break}try{await this.initUserFunction(c),this.emitMessage({type:"success",queryKey:s})}catch(l){this.emitMessage({type:"error",error:l,queryKey:s})}}}),Object.defineProperty(this,"initUserFunction",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{await this.driver.createFunction(e),this.userFunctions.set(e.name,e)}}),Object.defineProperty(this,"importDb",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{const{queryKey:i,database:r}=e;let s=!1;try{await this.driver.import(r),this.driver.storageType==="memory"&&await this.execInitStatements()}catch(c){this.emitMessage({type:"error",error:c,queryKey:i}),s=!0}finally{this.driver.storageType!=="memory"&&await this.init("overwrite")}s||this.emitMessage({type:"success",queryKey:i})}}),Object.defineProperty(this,"exportDb",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{const{queryKey:i}=e;try{const{name:r,data:s}=await this.driver.export();this.emitMessage({type:"buffer",queryKey:i,bufferName:r,buffer:s},[s])}catch(r){this.emitMessage({type:"error",error:r,queryKey:i})}}}),Object.defineProperty(this,"deleteDb",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{const{queryKey:i}=e;let r=!1;try{await this.driver.clear()}catch(s){this.emitMessage({type:"error",error:s,queryKey:i}),r=!0}finally{await this.init("delete")}r||this.emitMessage({type:"success",queryKey:i})}}),Object.defineProperty(this,"destroy",{enumerable:!0,configurable:!0,writable:!0,value:async e=>{await this.driver.exec({sql:"PRAGMA optimize"}),await this.driver.destroy(),this.effectsChannel&&(this.emitEffectsDebounced.flush(),this.effectsChannel.close(),this.effectsChannel=void 0),this.reinitChannel&&(this.reinitChannel.close(),this.reinitChannel=void 0),e&&this.emitMessage({type:"success",queryKey:e.queryKey})}});const n=typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope?R(globalThis):globalThis;this.proxy=n,this.driver=t}}const oe=new G,Q=new ne(oe);self.onmessage=o=>{Q.postMessage(o)};Q.onmessage=(o,t)=>{self.postMessage(o,t)};
